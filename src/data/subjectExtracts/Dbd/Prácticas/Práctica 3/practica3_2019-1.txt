# Extracted content
Source: subjects/Dbd/Prácticas/Práctica 3/practica3_2019-1.pdf

### Page 1
Práctica 3
Recuperación de bases de datos
en Oracle
1

### Page 2
2
Práctica 3.
 Estudiar la estrategia de actualización de la base de datos que
se sigue en Oracle.
 Estudiar los elementos que intervienen en la estrategia de
recuperación de la base de datos en Oracle.
 Comprobar experimentalmente la estrategia de recuperación
en Oracle.
Objetivos:
2

### Page 3
3
Práctica 3. Estrategia de actualización en Oracle
 Entorno concurrente.
 Actualización en el lugar.
 Actualización inmediata.
 Actualización no forzar.
Algoritmo
DESHACER/REHACER
3

### Page 4
4
Práctica 3.
Elementos utilizados en el procesamiento de transacciones y en la
estrategia de recuperación en el SGBD Oracle:
 Buffer de datos.
 Buffer de diario.
 Fichero de diario.
 Espacio de deshacer.
Estrategia de recuperación en Oracle
[escribir, T, X, valor_antes, valor_después]
Como se ha presentado en el Tema 3, en un diario se registran todas las operaciones que
realizan las transacciones, con fines de recuperación de la BD: deshacer una transacción anulada
o interrumpida, o rehacer una transacción confirmada.
Para poder deshacer o rehacer una actualización de una transacción es necesario guardar en el
diario el valor anterior y el valor posterior a dicha actualización, como se indica en la entrada de
tipo [escribir, T, X, valor_antes, valor_después]
La particularidad de Oracle reside en que estas dos informaciones (valores de X) se almacenan
en dos repositorios distintos:
• En un fichero de datos del servidor (Espacio de Deshacer) y
• En el fichero de diario del servidor.
Como se presentará en la Práctica 5, Oracle utiliza para gestionar el espacio disponible en disco
(los ficheros de datos) una organización particular. El espacio en disco destinado a datos se
organiza en espacios de distinto tamaño (tablespaces en la terminología de Oracle), gestionados
por el servidor. Uno de estos espacios se destina a almacenar las anotaciones con los valores
anteriores de los datos actualizados, para poder deshacer transacciones durante la recuperación
de la BD. Por este motivo se habla de Espacio de Deshacer (Undo Tablespace).
En el fichero de diario se almacenan las anotaciones con el valor posterior  de los datos
actualizados para poder rehacer transacciones durante la recuperación de la BD.
En la transparencia se indica el destino final de estos dos valores del dato actualizado
(valor_antes y valor_después). En las transparencias siguientes se presentará con más detalle el
uso de estos dos repositorios.
4

### Page 5
5
CKPT
LGWR
DBWR
 PMON
SMON
 ARC
Instancia
Buffers datos Buffer diario
Área compartida
Práctica 3. Estrategia de recuperación en Oracle
Base de datos Oracle
Ficheros de
control
Ficheros de
datos
Ficheros de
diario
Memoria Principal Memoria Secundaria
Bloques
de diario
Bloques
de datos
Bloques de
deshacer
Como se ha visto en prácticas anteriores, en la SGA de la instancia, de un servidor Oracle, existen
dos tipos de buffers: el buffer de diario y el buffer de datos.
En el buffer de datos se trasfieren temporalmente los bloques de los ficheros de datos que son
accedidos durante el uso del servidor. Estos bloques pueden ser de dos tipos:
• Bloques de datos (bloques de objetos de datos), o
• Bloques del espacio de deshacer.
En el buffer de diario se trasfieren bloques del fichero de diario.
Los bloques transferidos a memoria principal serán devueltos (grabados) al disco en instantes de
tiempo determinados por la estrategia de actualización de la BD y los parámetros de
configuración del servidor.
5

### Page 6
6
Práctica 3.
Fichero
de diario
Fichero
de datos
Espacio de
deshacer
Objeto de
datos
En la actualización de un elemento de datos (X):
 El valor_después se escribe en el objeto de datos
 El valor_antes se escribe en el espacio de deshacer
 Ambos modificaciones (escrituras) son registradas antes en el
fichero de diario con fines de recuperación.
Buffer de
datos
6
[escribir, T, X, valor_antes, valor_después ]
Buffer de
diario
4
1
2
3
Estrategia de recuperación en Oracle
Debido a la forma particular, en Oracle, de almacenar la información relativa a una operación de
actualización, es importante entender el destino de cada información para la recuperación,
teniendo en cuenta que las actualizaciones realizadas en el espacio de deshacer (valor_antes)
reciben el mismo tratamiento, respecto a la política de recuperación, que las actualizaciones de
los objetos de datos, es decir, que el hecho de escribir en el espacio de deshacer implica hacer
una anotación en el fichero de diario. Así:
• El valor del dato antes de la actualización (valor_antes) se escribe en el correspondiente
bloque del espacio de deshacer residente temporalmente en el buffer de datos. Una
anotación con la inserción realizada en el espacio de deshacer (valor_antes) es también
registrada previamente en el buffer de diario. (En el espacio de deshacer sólo se hacen
inserciones).
• El valor del dato después de la actualización (valor_después) se escribe en el correspondiente
bloque del objeto de datos residente temporalmente en el buffer de datos. Una anotación
con el valor actualizado (valor_después) es registrada previamente en el buffer de diario.
Los bloques de datos y de deshacer en los que se han hecho actualizaciones, en el buffer de
datos, serán devueltos a su posición en el disco en algún momento posterior.
El contenido del buffer de diario será grabado en el fichero de diario en disco siguiendo una
política que asegura tener en disco toda la información necesaria para la recuperación de la base
de datos en caso de fallo. (Algoritmo de gestión del fichero de diario).
6

### Page 7
7
Práctica 3.
Espacio de deshacer
(fichero de datos)
Tabla
(fichero de datos)
actualización del elemento
de datos X
Fichero de
diario
7
X
escribir[T, X, valor_después]
escribir[T, X, valor_antes]
escribir [T,  X,  valor_antes]
escribir (X)
Buffer de
diario
1
Buffer de
datos
2
34
Estrategia de recuperación en Oracle
Esta transparencia visualiza más detalladamente lo que ya se ha descrito en la transparencia
anterior.
Es importante destacar:
• Cualquier bloque (datos, deshacer, diario) debe ser transferido al buffer correspondiente
para su actualización, y posteriormente debe ser salvado (grabado) en disco.
• Cualquier actualización que se hace en el espacio de deshacer o en los objetos de datos debe
ser anotada previamente en el fichero de diario.
• En el espacio de deshacer se registran los valores anteriores de los datos con fines de
recuperación (deshacer transacciones), pero estas inserciones en el espacio de deshacer son
anotadas también en el fichero de diario. Si se perdiese el contenido del espacio de deshacer
por algún fallo, éste podría ser reconstruido usando el diario.
El uso de un espacio de deshacer (valor_antes) en Oracle responde únicamente a razones de
rendimiento. Las mismas medidas de seguridad podrían tomarse usando exclusivamente un
fichero de diario clásico.
Con el uso del espacio de deshacer se pretende tener más accesible la información necesaria
para deshacer transacciones, ya que esta tarea se realiza con mucha más frecuencia (usuario,
SGBD) que la tarea de rehacer (fallo del sistema).
7

### Page 8
8
8
transacciones bloques de datos
Buffer de diario (MP)
t1
UPDATE profesor
SET cod_dep=‘DISCA’
WHERE cod_pro=‘JCC’;
[leer, T1, X]
t2 commit
fallo del
sistemat10
Buffers de datos (MP)
t4
confirmación
del SGBD
bloques de deshacer
Profesor
BD
[escribir, T1 ,X, <JCC … DSIC>]
[escribir, T1 , X, <JCC … DISCA>]
[commit, T1]
[escribir, T2 , Y , <MCG … DISCA>]
[escribir, T1 , X, <JCC … DSIC>]
<JCC  …  DISCA>
Forzar
escritura en
el diariot3
<MCG … DSIC>
[leer, T2, Y]
[escribir, T2 , Y , <MCG … DSIC>] [escribir, T2 , Y , <MCG … DSIC>]
t6t7
Escritura
anticipada
en el diario
bloques de diario
diario
Espacio
para datos
Espacio de
deshacer
<JCC  …  DSIC>
t5
UPDATE profesor
SET cod_dep=‘DISCA’
WHERE cod_pro=‘MCG’;
…
Ficheros
de diario
Ficheros
de datos
Bloques de
deshacer
Bloques de
datos
Práctica 3. Estrategia de recuperación en Oracle
<MCG … DISCA>
En la transparencia se ilustra con un ejemplo la situación en que puede quedar la base
de datos (en disco) después de un fallo del sistema con pérdida de memoria principal,
en el supuesto de la estrategia de actualización planteada.
8

### Page 9
9
Rehacer
Deshacer
tiempo
T1 (confirmada)
T2 (interrumpida)
t1 t10t4 t5
Algoritmo DESHACER/REHACER
Reconstruir
(espacio de
deshacer)
Práctica 3. Estrategia de recuperación en Oracle
punto de control fallo del sistema
Éste es el proceso de recuperación de la base de datos del ejemplo anterior después del fallo.
Deberán deshacerse las actualizaciones de las transacción T2 y rehacerse las actualizaciones de
la transacción T1 que es la única confirmada después del último punto de control. Para deshacer
T2, primero reconstruirá el espacio de deshacer usando el diario.
9

### Page 10
10
Fallo del sistema con pérdida de MP: Algoritmo Deshacer/Rehacer
a) En el fichero de diario en disco se encuentran los cambios realizados por
las transacciones confirmadas antes del fallo del sistema (las
transacciones que hicieron estos cambios pueden no haber sido grabados
en la BD en disco).
b) En el fichero de diario en di sco se encuentran todos los cambios
realizados sobre bloques del espacio de deshacer correspondientes a
cambios en bloques de datos que ya han sido transferidos a disco (las
transacciones que hicieron estos cambios pueden haber sido
interrumpidas).
Forzar la escritura
en el diario
Escritura anticipada
en el diario
Práctica 3. Estrategia de recuperación en Oracle
a) Debido al algoritmo de gestión del fichero de di ario (forzar la escritura en el diario) antes de
confirmar una transacción, el SGBD transfiere a disco el contenido del buffer de diario, es
decir salva en el fichero de diario los cambios realizados por la transacción (valor_despues),
independientemente de que estos cambios hayan sido grabados o no en el disco. Esto
permite rehacer la transacción confirmada en caso de fallo del sistema.
b) Debido al algoritmo de gestión del fichero de diar io (escritura anticipada en el diario), en el
fichero de diario se encuentran los cambios realizados en el espacio de deshacer que son
necesarios para deshacer las actualizaciones (valor_antes) de las transacciones
interrumpidas que ya hayan sido grabadas en disco.
10

### Page 11
11
Fallo del sistema con pérdida de MP: Algoritmo Deshacer/Rehacer
Estrategia de recuperación:
a) Se aplican sobre la BD los cambios registrados en el fichero de diario en
disco, desde el último punto de control: se rehacen las transacciones
confirmadas y se reconstruye el espacio de deshacer en disco. (REHACER)
b) Utilizando las entradas del espacio de  deshacer en disco, se deshacen
todos los cambios producidos por transacciones interrumpidas por el fallo
del sistema.(DESHACER)
Práctica 3. Estrategia de recuperación en Oracle
11

### Page 12
12
Sincronización de la BD y el espacio
de deshacer en disco con el estado
del buffer de datos en el momento
del fallo.
Anulación de cambios de
transacciones
interrumpidas.
Espacio de
deshacer
REHACER DESHACER
Práctica 3. Estrategia de recuperación en Oracle
BD que necesita
recuperación
BD
BD con cambios de
transacciones
confirmadas e
interrumpidas
BD
BD con datos de
transacciones
confirmadas
BD
Ficheros
de diario
Al aplicar el procedimiento REHACER:
• Rehacemos, con la información del fichero de diario (valor_después) las transacciones
confirmadas antes del fallo y posteriores al último punto de control. Algunos de los cambios
de estas transacciones podrían haberse quedado en el buffer de datos en el momento del
fallo.
• Rehacemos el espacio de deshacer en disco con la información del fichero de diario. Esto
asegura que en el espacio de deshacer en disco, después de la restauración, están registrados
los cambios (valor_antes) de las transacciones activas en el momento del fallo, realizados
sobre bloques de datos que ya han sido transferidos al disco.  Otros cambios de estas
transacciones interrumpidas no registrados todavía en disco no interesan.
Al aplicar el procedimiento DESHACER:
• Deshacemos los cambios de las transacciones interrumpidas.
12

### Page 13
13
Práctica 3. Estrategia de recuperación en Oracle
 Almacena los bloques de datos y del espacio de deshacer que han sido
accedidos más recientemente.
 Sirve para minimizar los accesos a disco.
 El SGBD gestiona de la misma forma los bloques de datos y los bloques
del espacio de deshacer.
Buffer de datos:
Como ya estudia en la práctica 1, el buffer de datos almacena temporalmente bloques de datos
y bloques del espacio de deshacer.
13

### Page 14
14
Práctica 3. Estrategia de recuperación en Oracle
Base de datos Oracle
Ficheros de
control
Ficheros de
datos
Ficheros de
diario
CKPT
LGWR
 PMON
SMON
 ARC
Instancia
Buffers datos Buffer diario
Área compartida DBWR:
 Hace falta espacio en el
buffer de datos.
 Antes de ejecutar un punto
de control.
 Periódicamente.
DBWR
Los criterios para que el proceso de fondo DBWR (Database Writer) actúe y transfiera bloques
(datos, deshacer) del buffer de datos al disco, pueden ser varios:
• El servidor necesita espacio en el buffer de datos para atender las peticiones de las
transacciones: transferir nuevos bloques de datos y de deshacer al buffer de datos.
• Antes de marcar un punto de control en el fichero de diario, el servidor transfiere a disco el
contenido del buffer de diario y los bloques del buffer de datos (sucios).
• En la configuración del servidor se puede establecer una periodicidad para transferir bloques
(sucios) del buffer de datos a disco.
14

### Page 15
 Almacena los cambios realizados por las transacciones sobre bloques
de datos y bloques del espacio de deshacer con fines de recuperación.
 Se utiliza secuencialmente.
 Buffer circular (se reescribe)
15
Práctica 3. Estrategia de recuperación en Oracle
Buffer de diario:
Como ya se estudia en la práctica 1, el buffer de diario almacena temporalmente bloques del
fichero de diario donde se anotan, entre otra información, las actualizaciones (valor_después)
realizadas sobre bloques de datos y bloques de deshacer.
15

### Page 16
16
Práctica 3. Estrategia de recuperación en Oracle
Base de datos Oracle
Ficheros de
control
Ficheros de
datos
Ficheros de
diario
LGWR:
 Confirmación de transacción.
 1/3 del buffer de diario lleno.
 Antes de que escriba el DBWR.
 Cada tres segundos.
CKPT
 PMON
SMON
 ARC
Instancia
Buffers datos
 Buffer diario
Área compartida
DBWR
 LGWR
Los criterios para que el proceso de fondo LGWR (Log Writer) actúe y transfiera el contenido del
buffer de diario al disco, pueden ser varios:
• Antes de que el servidor confirme una transacción: algoritmo de gestión del diario (forzar
escritura en el diario).
• Cuando una porción del buffer de diario previamente establecida está llena (configuración).
• Antes de que el proceso DBWR transfiera bloques del buffer de datos a disco: algoritmo de
gestión del diario (escritura anticipada en el diario).
• Con cierta periodicidad previamente establecida (configuración).
16

### Page 17
17
Práctica 3. Organización del diario en Oracle
Disco 1
Disco 2
El servidor Oracle trabaja con varios grupos de ficheros de diario.
Cada grupo de diario es un conjunto de ficheros de diario similares (miembros).
Grupo 1
Miembro
Miembro
Grupo 2
Miembro
Miembro
Grupo 3
Miembro
Miembro
Por razones de seguridad el servidor Oracle trabaja con varios grupos de diario.
Cada grupo de diario contiene un conjunto de ficheros de diario similares (miembros).
Por seguridad los miembros de un grupo de diario se suelen almacenar en discos distintos.
17

### Page 18
18
Práctica 3. Organización del diario en Oracle
Disco 1
Disco 2
• Existe un grupo actual que es el que está siendo utilizado por el servidor.
• El servidor actualiza  simultáneamente todos los miembros del grupo actual.
• Cuando los ficheros del grupo actual están llenos, el servidor pasa al grupo
siguiente. (Uso circular del conjunto de grupos de diario).
Grupo 1
Miembro
Miembro
Actual
Miembro
Miembro
Grupo 3
Miembro
Miembro
Buffer diario
LGWR
El fichero de diario tendría todas sus entradas entre los miembros de los distintos grupo (uno
por grupo).
Un grupo puede estar en varios estados:
• Actual: es sobre el que está escribiendo el LGWR.
• Activo: es posible que sus entradas sean necesarias para realizar recuperación ante fallos.
• Inactivo: sus entradas no son necesarias para recuperarse ante un fallo de sistema (por
ejemplo porque se ha hecho un checkpoint).
18

### Page 19
19
Práctica 3. Organización del diario en Oracle
Disco 1
Disco 2
Cuando un grupo de diario está completo puede ser archivado por razones de
seguridad. (Parámetro de configuración del servidor).
Los grupos se sobreescriben cuando están llenos. Antes de esto deberían estar en
estado inactivo y archivarse.
Grupo 1
Miembro
Miembro
Grupo 2
Miembro
Miembro
Actual
Miembro
Miembro
ARCH
Ficheros de
diario archivados
19

### Page 20
20
Práctica 3. Organización del diario en Oracle
Gestión de grupos de diario
en SQL Developer
En el servidor prueba existen 3 grupos de diario, cada
uno de ellos con un fichero de diario.
El grupo #1 es el grupo de
diario actual en este momento
En la instalación del laboratorio los tres miembros de cada grupo del diario están en el mismo
disco (incluso en el mismo directorio). Esto no debería ser así para que la instalación  fuera
robusta.
20
